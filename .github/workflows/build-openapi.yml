name: OpenAPI

on: [pull_request]

jobs:
  build-and-pr:
    runs-on: ubuntu-latest
    env:
      accesToken: ${{ secrets.ACCESS_TOKEN }}
    steps:
      - uses: actions/checkout@v2

      - name: Install Modules
        run: npm i

      - name: Compile TS
        run: npm run build:ts

      - name: Build OpenAPI
        run: npm run build:openapi

      - name: Configure Git
        run: |
          git config --global user.email "eng@browserless.io"
          git config --global user.name "OpenAPI Bot"
          git config --global --add --bool push.autoSetupRemote true

      - name: Clone Target Repository
        run: |
          git clone https://${{ env.accesToken }}@github.com/browserless/browserless-docs.git ./docs-repo
      - name: Copy File to Target Repository
        run: |
          cp ./static/docs/swagger.json ./docs-repo

      - name: Commit and Push
        run: |
          cd ./docs-repo
          git checkout -b docs/openapi
          git add .
          git commit -m "chore: update openapi"
          git push
      - name: Create Pull Request
        run: gh pr create -B main -H docst/openapi --title 'Update OpenAPI' --body 'Created by Github action'
